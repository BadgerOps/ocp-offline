{{define "content"}}
<div class="card">
	<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
		<div>
			<h2 style="font-family: var(--font-mono); font-size: 18px; margin-bottom: 8px;">{{.Provider}}</h2>
			{{if .Status.Enabled}}
			<span class="badge badge-enabled">ACTIVE</span>
			{{else}}
			<span class="badge badge-disabled">DISABLED</span>
			{{end}}
		</div>
		<a href="/providers" class="btn btn-sm">&larr; All Providers</a>
	</div>

	<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 24px; margin-bottom: 24px;">
		<div>
			<div class="stat-value">{{.Status.FileCount}}</div>
			<div class="stat-label">Files Synced</div>
		</div>
		<div>
			<div class="stat-value">{{formatBytes .Status.TotalSize}}</div>
			<div class="stat-label">Total Size</div>
		</div>
		<div>
			{{if not (.Status.LastSync.IsZero)}}
			<div class="stat-value" style="font-size: 16px;">{{formatTime .Status.LastSync}}</div>
			<div class="stat-label">Last Sync</div>
			{{else}}
			<div class="stat-value" style="font-size: 16px; color: var(--text-muted);">Never</div>
			<div class="stat-label">Last Sync</div>
			{{end}}
		</div>
		{{if gt .Status.FailedFiles 0}}
		<div>
			<div class="stat-value" style="color: var(--red);">{{.Status.FailedFiles}}</div>
			<div class="stat-label">Failed Files</div>
		</div>
		{{end}}
	</div>

	<hr class="section-divider">

	<div class="btn-group">
		<button class="btn btn-primary" hx-post="/api/sync" hx-vals='{"provider":"{{.Provider}}","dry_run":"false"}' hx-target="#sync-result" hx-swap="innerHTML">
			Sync Now
		</button>
		<button class="btn" hx-post="/api/sync" hx-vals='{"provider":"{{.Provider}}","dry_run":"true"}' hx-target="#sync-result" hx-swap="innerHTML">
			Dry Run
		</button>
		<button class="btn" hx-post="/api/scan" hx-vals='{"provider":"{{.Provider}}"}' hx-target="#sync-result" hx-swap="innerHTML">
			Check Local
		</button>
			<button class="btn" hx-post="/api/validate" hx-vals='{"provider":"{{.Provider}}"}' hx-target="#sync-result" hx-swap="innerHTML">
				Validate
			</button>
			{{if .SyncRunning}}
			<button class="btn btn-danger" hx-post="/api/sync/cancel" hx-target="#sync-result" hx-swap="innerHTML">
				Cancel
			</button>
			{{end}}
		</div>
	<div id="sync-result" style="margin-top: 12px;"></div>
</div>

{{if .SyncRuns}}
<div class="card">
	<h2>Sync History</h2>
	<p class="card-desc">Last {{len .SyncRuns}} sync operations for this provider.</p>
	<div style="overflow-x: auto;">
		<table>
			<thead>
				<tr>
					<th>Started</th>
					<th>Duration</th>
					<th>Status</th>
					<th>Downloaded</th>
					<th>Skipped</th>
					<th>Failed</th>
					<th>Size</th>
				</tr>
			</thead>
			<tbody>
				{{range .SyncRuns}}
				<tr>
					<td style="font-family: var(--font-mono); font-size: 12px; white-space: nowrap;">{{formatTime .StartTime}}</td>
					<td style="font-family: var(--font-mono); font-size: 12px;">{{if not (.EndTime.IsZero)}}{{formatDuration .StartTime .EndTime}}{{else}}&mdash;{{end}}</td>
					<td><span class="badge badge-{{.Status}}">{{.Status}}</span></td>
					<td style="font-family: var(--font-mono); font-size: 13px;">{{.FilesDownloaded}}</td>
					<td style="font-family: var(--font-mono); font-size: 13px;">{{.FilesSkipped}}</td>
					<td style="font-family: var(--font-mono); font-size: 13px;">{{if gt .FilesFailed 0}}<span style="color: var(--red);">{{.FilesFailed}}</span>{{else}}0{{end}}</td>
					<td style="font-family: var(--font-mono); font-size: 12px; white-space: nowrap;">{{formatBytes .BytesTransferred}}</td>
				</tr>
				{{end}}
			</tbody>
		</table>
	</div>
</div>
{{end}}

{{if .CanPushToRegistry}}
<div class="card">
	<h2>Push To Registry</h2>
	<p class="card-desc">Push this provider's mirrored images to a configured destination registry target.</p>
	{{if gt (len .RegistryTargets) 0}}
	<form hx-post="/api/registry/push" hx-target="#sync-result" hx-swap="innerHTML">
		<input type="hidden" name="source_provider" value="{{.Provider}}">
		<div class="form-row">
			<div class="form-group">
				<label>Target Registry Provider</label>
				<select name="target_provider" required>
					<option value="">Select target&hellip;</option>
					{{range .RegistryTargets}}
					<option value="{{.}}">{{.}}</option>
					{{end}}
				</select>
			</div>
			<div class="form-group">
				<label style="display: inline-flex; align-items: center; gap: 8px; text-transform: none; letter-spacing: normal; font-size: 13px; cursor: pointer; margin-top: 26px;">
					<input type="checkbox" name="dry_run" value="true">
					<span>Dry run only</span>
				</label>
			</div>
		</div>
		<div class="btn-group">
			<button class="btn btn-primary" type="submit">Push Images</button>
		</div>
	</form>
	{{else}}
	<p class="card-desc">No registry targets configured yet. Add a <strong>registry</strong> provider first.</p>
	{{end}}
</div>
{{end}}

{{if gt .Status.FailedFiles 0}}
<div class="card" style="border-left: 3px solid var(--red);" x-data="failedFilesPanel()" x-init="load('{{.Provider}}')">
	<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
		<div>
			<h2 style="color: var(--red);">Failed Files</h2>
			<p class="card-desc">{{.Status.FailedFiles}} file(s) failed to sync.</p>
		</div>
		<button class="btn btn-sm" @click="retry('{{.Provider}}')" :disabled="retrying"
			x-text="retrying ? 'Retrying...' : 'Retry Failed'"></button>
	</div>
	<div style="font-size: 12px; font-family: var(--font-mono); max-height: 300px; overflow-y: auto;">
		<template x-for="f in failures" :key="f.ID">
			<div style="display: flex; align-items: flex-start; gap: 8px; padding: 6px 0; border-bottom: 1px solid var(--border-subtle);">
				<span style="color: var(--red); flex-shrink: 0;">&#10007;</span>
				<div style="min-width: 0;">
					<div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--text-secondary);" x-text="f.FilePath"></div>
					<div style="color: var(--red); font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" x-text="f.Error"></div>
				</div>
			</div>
		</template>
	</div>
</div>
{{end}}
{{end}}
